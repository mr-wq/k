<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Monaco Editor</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Monaco Editor</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style type="text/css">
        html,
        body {
            background: #0b0d14; /* dark red -> dark blue */
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: consolas, "poppins", monospace;
            color: #73A7FF; /* light red -> light blue */
            display: flex;
            flex-direction: column;
        }

      #container {
        width: 100%;
        height: 100%;
      }

      #backdrop {
        position: fixed;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(11, 13, 20, 0.5);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        z-index: 1999;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease-out;
      }
      #backdrop.open {
        opacity: 1;
        pointer-events: auto;
      }
      #sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100vh;
        width: 220px;
        background: #0b0d14;
        border-right: 1px solid #2c3240;
        z-index: 2000;
        transform: translateX(-100%);
        transition: transform 0.3s cubic-bezier(0.33, 1, 0.68, 1);
        display: flex;
        flex-direction: column;
        padding: 16px;
        gap: 8px;
        font-family: "Inter", sans-serif;
      }
      #sidebar.open {
        transform: translateX(0);
      }
      .sidebar-btn {
        background: transparent;
        border: none;
        color: #73A7FF;
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 10px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-family: "Inter", sans-serif;
        font-size: 14px;
        font-weight: 500;
        text-align: left;
        transition: background-color 0.2s ease, color 0.2s ease;
        width: 100%;
      }
      .sidebar-btn:hover {
        background-color: #182033;
        color: #ffffff;
      }
      .sidebar-btn svg {
        width: 20px;
        height: 20px;
        stroke: #73A7FF;
        flex-shrink: 0;
        transition: stroke 0.2s ease;
      }
      .sidebar-btn:hover svg {
        stroke: #ffffff;
      }

      .toast-container {
        position: fixed;
        bottom: 10px;
        right: 10px;
        z-index: 9999;
      }
      .toast {
        padding: 12px 16px;
        margin: 8px;
        border-radius: 6px;
        color: white;
        font-family: "Inter", sans-serif;
        font-size: 11px;
        opacity: 0;
        transform: translateX(50px);
        filter: blur(8px);
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        background-color: rgba(59, 130, 246, 0.9);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        max-width: 180px; 
        width: fit-content; 
      }
      .toast.show {
        opacity: 1;
        transform: translateX(0);
        filter: blur(0);
      }
      .toast .toast-title {
        font-weight: 600;
        margin-bottom: 6px;
        color: #fff;
      }
      .toast .toast-code {
        background: rgba(0,0,0,0.3);
        border-radius: 4px;
        font-family: "JetBrains Mono", monospace;
        font-size: 8px;
        padding: 6px 8px;
        white-space: pre;     
        overflow-x: auto;      
        max-height: 160px;      
      }

      #main-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100vw;
      }
    </style>
  </head>

  <body>
    <div id="main-container">
      <div class="toast-container"></div>
      <div id="container"></div>
    </div>
    
    <div id="backdrop"></div>
    <div id="sidebar">
      <button class="sidebar-btn" data-nav="Home">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 9.22222V21H21V9.22222L12 3L3 9.22222Z" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/><path d="M9 21V12H15V21" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>Home</span>
      </button>
      <button class="sidebar-btn" data-nav="Editor">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 8L3 12L7 16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M17 8L21 12L17 16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 4L10 20" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>Editor</span>
      </button>
      <button class="sidebar-btn" data-nav="ScripHub">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 16V8C21 7.46957 20.7893 6.96086 20.4142 6.58579C20.0391 6.21071 19.5304 6 19 6H5C4.46957 6 3.96086 6.21071 3.58579 6.58579C3.21071 6.96086 3 7.46957 3 8V16C3 16.5304 3.21071 17.0391 3.58579 17.4142C3.96086 17.7893 4.46957 18 5 18H19C19.5304 18 20.0391 17.7893 20.4142 17.4142C20.7893 17.0391 21 16.5304 21 16Z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 10L12 14L21 10" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 6V14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>ScripHub</span>
      </button>
      <button class="sidebar-btn" data-nav="Settings">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M19.4 15L19.4 15C19.8242 14.6543 20.1743 14.2127 20.421 13.714C20.6677 13.2153 20.8049 12.6739 20.824 12.12C20.8431 11.5661 20.7439 11.0123 20.5338 10.5056C20.3238 9.99882 20.0076 9.55169 19.6 9.2L19.6 9.2C19.2312 8.89945 18.788 8.70515 18.318 8.64333C17.848 8.58151 17.3712 8.65529 16.94 8.855C16.5088 9.05471 16.1387 9.37332 15.865 9.775C15.5913 10.1767 15.424 10.647 15.38 11.14L15.38 11.14M9.62 12.86L9.62 12.86C9.57599 13.353 9.40875 13.8233 9.13503 14.225C8.86131 14.6267 8.49122 14.9453 8.06 15.145C7.62878 15.3447 7.15199 15.4185 6.682 15.3567C6.21201 15.2949 5.76878 15.1005 5.4 14.8L5.4 14.8C5.00762 14.4483 4.6762 14.0012 4.432 13.4944C4.18781 12.9877 4.03791 12.434 3.996 11.87C3.95408 11.306 4.02213 10.7423 4.195 10.225C4.36787 9.70773 4.64092 9.24838 5 8.86L5 8.86C5.36878 8.50055 5.81201 8.30616 6.282 8.24434C6.75199 8.18252 7.22878 8.2563 7.66 8.456C8.09122 8.65571 8.46131 8.97432 8.73503 9.376C9.00875 9.77768 9.17599 10.248 9.22 10.74L9.22 10.74M12.86 15.38L12.86 15.38C13.353 15.424 13.8233 15.5913 14.225 15.865C14.6267 16.1387 14.9453 16.5088 15.145 16.94C15.3447 17.3712 15.4185 17.848 15.3567 18.318C15.2949 18.788 15.1005 19.2312 14.8 19.6L14.8 19.6C14.4483 19.9924 14.0012 20.3238 13.4944 20.568C12.9877 20.8122 12.434 20.9621 11.87 21.004C11.306 21.0459 10.7423 20.9779 10.225 20.805C9.70773 20.6321 9.24838 20.3591 8.86 20L8.86 20C8.50055 19.6312 8.30616 19.188 8.24434 18.718C8.18252 18.248 8.2563 17.7712 8.456 17.34C8.65571 16.9088 8.97432 16.5387 9.376 16.265C9.77768 15.9913 10.248 15.824 10.74 15.78L10.74 15.78M11.14 9.22L11.14 9.22C11.593 9.17599 12.0633 9.00875 12.465 8.73503C12.8667 8.46131 13.1853 8.09122 13.385 7.66C13.5847 7.22878 13.6585 6.75199 13.5967 6.282C13.5349 5.81201 13.3405 5.36878 13.04 5L13.04 5C12.6883 4.60762 12.2412 4.2762 11.7344 4.032C11.2277 3.78781 10.674 3.63791 10.11 3.596C9.54602 3.55408 8.98234 3.62213 8.46503 3.795C7.94773 3.96787 7.48838 4.24092 7.1 4.6L7.1 4.6C6.70055 4.96878 6.50616 5.41201 6.44434 5.882C6.38252 6.35199 6.4563 6.82878 6.656 7.26C6.85571 7.69122 7.17432 8.06131 7.576 8.33503C7.97768 8.60875 8.44801 8.77599 8.94 8.82L8.94 8.82" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>Settings</span>
      </button>
    </div>

    <script src="https://unpkg.com/luaparse@0.3.1/luaparse.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>

    <script type="text/javascript">
      window.addEventListener("load", function () {
        // --- Sidebar Logic ---
        const sidebar = document.getElementById("sidebar");
        const backdrop = document.getElementById("backdrop");
        const sidebarButtons = document.querySelectorAll(".sidebar-btn");

        window.openNav = function() { 
            sidebar.classList.add("open");
            backdrop.classList.add("open");
        }

        window.closeNav = function() { 
            sidebar.classList.remove("open");
            backdrop.classList.remove("open");
            sidebarButtons.forEach(btn => btn.classList.remove("selected"));
        }
        
        sidebarButtons.forEach(button => {
            button.addEventListener("click", (event) => {
                sidebarButtons.forEach(btn => btn.classList.remove("selected"));
                const clickedButton = event.currentTarget;
                clickedButton.classList.add("selected");
                const navItem = clickedButton.dataset.nav;
                
                if (window.CefSharp && CefSharp.PostMessage) {
                    CefSharp.PostMessage({ type: 'navClick', item: navItem });
                }
                setTimeout(closeNav, 200); 
            });
        });

        backdrop.addEventListener("click", closeNav);
      });

      // Default Script Content
      const defaultContent = `--[[ Chart Executor - 99 UNC ]]--`;


      // Configure RequireJS to load Monaco from CDN
      require.config({
        paths: {
          vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs",
        },
      });

      var GetText;
      var SetText;
      var SetScroll;
      var ShowError;
      var Refresh;
      var SwitchMinimap;
      var SwitchReadonly;
      var SwitchRenderWhitespace;
      var SwitchLinks;
      var SwitchLineHeight;
      var SwitchFontSize;
      var SwitchFolding;
      var SwitchAutoIndent;
      var SwitchFontFamily;
      var SwitchFontLigatures;
      var AddIntellisense;
      var editor;
      var Proposals = [];

      require(["vs/editor/editor.main"], function () {
        function getDependencyProposals() {
          let newProposals = [];
          for (let index = 0; index < Proposals.length; index++) {
            const element = Proposals[index];
            let newElement = {};
            for (const key in element) {
              if (key == "__children__") {
                continue;
              }
              newElement[key] = element[key];
            }
            newProposals.push(newElement);
          }
          return newProposals;
        }
	
	 window.onresize = function () {
                    editor.layout();
                };

                window.GetText = function () {
                    return editor.getValue();
                };

                window.SetText = function (x) {
                    editor.setValue(String(x));
                    if (activeTab) {
                        activeTab.content = editor.getValue();
                        saveTabsToLocalStorage();
                    }
                };
        // --- NEW SINGLE THEME (Light Red) ---
        monaco.editor.defineTheme("custom-blue", {
  base: "vs-dark",
  inherit: true,
  rules: [
    { token: "keyword", foreground: "73A7FF", fontStyle: "bold" },
    { token: "string", foreground: "9DBDFF" },
    { token: "number", foreground: "73A7FF" },
    { token: "comment", foreground: "404f80" },
    { token: "variable", foreground: "73A7FF" },
    { token: "entity.name.function", foreground: "73A7FF", fontStyle: "bold" },
    { token: "delimiter", foreground: "73A7FF" }
  ],
  colors: {
    "editor.background": "#0b0d14",
    "editor.foreground": "#73A7FF",
    "editorLineNumber.foreground": "#2b3f6d",
    "editorLineNumber.activeForeground": "#73A7FF",
    "editor.lineHighlightBackground": "#141c2e",
    "editor.lineHighlightBorder": "#222f4d",
    "editorCursor.foreground": "#73A7FF",
    "editor.selectionBackground": "#73A7FF33",
    "editorSuggestWidget.background": "#141c2e",
    "editorSuggestWidget.border": "#222f4d",
    "editorSuggestWidget.foreground": "#73A7FF",
    "editorSuggestWidget.selectedBackground": "#222f4d"
  }
});


        require(["vs/basic-languages/monaco.contribution"], function () {
          monaco.languages.registerCompletionItemProvider("lua", {
            provideCompletionItems: function (model, position) {
              return {
                suggestions: getDependencyProposals(),
              };
            },
            triggerCharacters: [".", ":", '"'],
          });
          
          // Initialize Editor (Single Instance)
          editor = monaco.editor.create(document.getElementById("container"), {
            value: defaultContent,
            language: "lua",
            theme: "custom-blue", // Use the new red theme
            folding: true,
            dragAndDrop: true,
            links: true,
            minimap: {
              enabled: true,
            },
            showFoldingControls: "always",
            smoothScrolling: true,
            stopRenderingLineAfter: 6500,
            fontSize: 12,
            fontFamily: "cascadia mono",
            cursorBlinking: "smooth",
            cursorSmoothCaretAnimation: true,
            foldingHighlight: false,
            fontLigatures: true,
            formatOnPaste: true,
            showDeprecated: true,
            suggest: {
              snippetsPreventQuickSuggestions: false,
              maxVisibleSuggestions: 12,
            },
            lineNumbersMinChars: 4,
          });
          editor.getModel().updateOptions({ insertSpaces: false });

          const debouncedCheck = debounce(validateLuaCode, 400);

          editor.onDidChangeModelContent(() => {
            debouncedCheck();
          });

          setTimeout(validateLuaCode, 500); 
        });

        window.onresize = function () {
          editor.layout();
        };
        Cut = function () {
          editor.focus();
          document.execCommand("cut");
        };
        Copy = function () {
          editor.focus();
          document.execCommand("copy");
        };
        Paste = function () {
          editor.focus();
          document.execCommand("paste");
        };
        Undo = function () {
          editor.focus();
          document.execCommand("undo");
        };
        Redo = function () {
          editor.focus();
          document.execCommand("redo");
        };
        Delete = function () {
          editor.focus();
          document.execCommand("delete");
        };
        SelectAll = function () {
          editor.focus();
          document.execCommand("selectAll");
        };
        GetText = function () {
          return editor.getValue();
        };
        SetText = function (x) {
          editor.setValue(x);
        };
        GetProposals = function () {
          return Proposals;
        };
        OnDidChangeContent = function (callback) {
          return editor.onDidChangeModelContent((event) => {
            callback(editor.getValue());
          });
        };
        OnDidChangeCursorPosition = function (callback) {
          return editor.onDidChangeCursorPosition((event) => {
            callback(event.position);
          });
        };
        
        SwitchMinimap = function (flag) {
          editor.updateOptions({ minimap: { enabled: flag } });
        };
        SwitchReadonly = function (flag) {
          editor.updateOptions({ readOnly: flag });
        };
        SwitchRenderWhitespace = function (op) {
          editor.updateOptions({ renderWhitespace: op });
        };
        SwitchLinks = function (flag) {
          editor.updateOptions({ links: flag });
        };
        SwitchLineHeight = function (num) {
          editor.updateOptions({ lineHeight: num });
        };
        SwitchFontSize = function (num) {
          editor.updateOptions({ fontSize: num });
        };
        SwitchFolding = function (flag) {
          editor.updateOptions({ folding: flag });
        };
        SwitchAutoIndent = function (flag) {
          editor.updateOptions({ autoIndent: flag });
        };
        SwitchFontFamily = function (name) {
          editor.updateOptions({ fontFamily: name });
        };
        SwitchFontLigatures = function (flag) {
          editor.updateOptions({ fontLigatures: flag });
        };
        AddSnippet = function (kindName, snippetName, data) {
          let snippet = {
            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
            kind: monaco.languages.CompletionItemKind[kindName],
          };
          for (const key in data) {
            let value = data[key];
            if (key == "__children__") {
              continue;
            }
            snippet[key] = value;
          }
          if (!snippet.label) {
            snippet.label = snippetName;
          }
          if (!snippet.insertText) {
            snippet.insertText = snippetName;
          }
          Proposals.push(snippet);
        };
        AddRawSnippet = function (data) {
          Proposals.push(data);
        };
        SetScroll = function (line) {
          editor.revealLineInCenter({ lineNumber: line });
        };
        Refresh = function () {
          var Text = GetText();
          SetText(Text);
          editor.trigger("keyboard", "type", { text: Text });
        };
        AddIntellisense = function (l, k, d, i) {
          var t;
          switch (k) {
            case "Class": t = monaco.languages.CompletionItemKind.Class; break;
            case "Color": t = monaco.languages.CompletionItemKind.Color; break;
            case "Constructor": t = monaco.languages.CompletionItemKind.Constructor; break;
            case "Enum": t = monaco.languages.CompletionItemKind.Enum; break;
            case "Field": t = monaco.languages.CompletionItemKind.Field; break;
            case "File": t = monaco.languages.CompletionItemKind.File; break;
            case "Folder": t = monaco.languages.CompletionItemKind.Folder; break;
            case "Function": t = monaco.languages.CompletionItemKind.Function; break;
            case "Interface": t = monaco.languages.CompletionItemKind.Interface; break;
            case "Keyword": t = monaco.languages.CompletionItemKind.Keyword; break;
            case "Method": t = monaco.languages.CompletionItemKind.Method; break;
            case "Module": t = monaco.languages.CompletionItemKind.Module; break;
            case "Property": t = monaco.languages.CompletionItemKind.Property; break;
            case "Reference": t = monaco.languages.CompletionItemKind.Reference; break;
            case "Snippet": t = monaco.languages.CompletionItemKind.Snippet; break;
            case "Text": t = monaco.languages.CompletionItemKind.Text; break;
            case "Unit": t = monaco.languages.CompletionItemKind.Unit; break;
            case "Value": t = monaco.languages.CompletionItemKind.Value; break;
            case "Variable": t = monaco.languages.CompletionItemKind.Variable; break;
          }
          Proposals.push({
            label: l,
            kind: t,
            detail: d,
            insertText: i,
          });
        };
      });

    function debounce(fn, wait) {
      let t = null;
      return function () {
        const args = arguments;
        clearTimeout(t);
        t = setTimeout(function () {
          fn.apply(null, args);
        }, wait);
      };
    }

    function validateLuaCode() {
      const model = editor.getModel();
      if (!model) return;

      const code = model.getValue();
      let markers = [];

      try {
        luaparse.parse(code, {
          wait: false,
          comments: false,
          locations: true
        });
      } catch (err) {
        if (err && err.line) {
          const lineContent = model.getLineContent(err.line);
          markers.push({
            severity: monaco.MarkerSeverity.Error,
            message: err.message,
            startLineNumber: err.line,
            startColumn: err.column || 1,
            endLineNumber: err.line,
            endColumn: (err.column || 1) + 1
          });

          const errorTitle = `Syntax Error at line ${err.line}, col ${err.column || 1}: ${err.message}`;
          const preview = lineContent.trim().slice(0, 80);

          if (window.CefSharp && CefSharp.PostMessage) {
            CefSharp.PostMessage({
              type: "luaError",
              title: errorTitle,
              preview: preview
            });
          }
        }
      }

      monaco.editor.setModelMarkers(model, "luaparse", markers);

      if (markers.length === 0) {
        if (window.CefSharp && CefSharp.PostMessage) {
            CefSharp.PostMessage({ type: "clearErrors" });
        }
      }
    }
    </script>
  </body>
</html>
